name: CI/CD Pipeline

# Trigger conditions
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]


env:
  PYTHON_VERSION: '3.12'
  AWS_REGION: 'ap-southeast-2'

jobs:
  # Job 1: Code Quality Checks
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # Cache pip dependencies for faster runs
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black ruff mypy pytest
      
      - name: Run Black
        run: black --check app/
      
      - name: Run Ruff
        run: ruff check app/
      
      - name: Run Mypy
        run: mypy app/ --ignore-missing-imports
      
      - name: Run tests
        run: pytest tests/ -v

  # Job 2: Terraform Validation
  terraform-check:
    name: Terraform Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      # create dummy lambda zip so Terraform can validate
      - name: Create dummy Lambda deployment package
        run: |
          mkdir -p $(dirname terraform/lambda-deployment.zip) || true
          cd terraform
          # Create a minimal zip file so Terraform validation doesn't fail
          echo "dummy" > dummy.txt
          zip ../lambda-deployment.zip dummy.txt
          rm dummy.txt
      
      - name: Terraform Init
        run: terraform init
        working-directory: ./terraform
      
      - name: Terraform Validate
        run: terraform validate
        working-directory: ./terraform

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ./terraform
        continue-on-error: true 
        
      - name: Terraform Plan
        if: github.event_name == 'pull_request' && env.AWS_ACCESS_KEY_ID != ''
        run: terraform plan -no-color
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        continue-on-error: true 

  # Job 3: Docker Build Test
  docker-build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false  # Don't push to registry, just build
          load: true
          tags: ai-router:test
          cache-from: type=gha  # Use GitHub Actions cache
          cache-to: type=gha,mode=max
      
      - name: Test Docker container
        run: |
          docker run -d -p 8000:8000 --name test-container \
            -e USE_MOCK_AWS=true \
            ai-router:test

          # Wait for container to start
          sleep 10

          # Check if container is running
          docker ps | grep test-container

          # Test health endpoint
          curl -f http://localhost:8000/health || exit 1

          # Cleanup
          docker stop test-container

  # Job 4: Security Scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Scan Python dependencies for known vulnerabilities
      - name: Run pip-audit
        uses: pypa/gh-action-pip-audit@v1.0.8
        with:
          inputs: requirements.txt
        continue-on-error: true  # Don't fail build on vulnerabilities (for now)
      
      # Scan for secrets in code
      - name: Secret scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true  # Don't fail build on secrets detection


  # Job 5: Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint-and-test, terraform-check, docker-build]
    if: always()  # Run even if previous jobs failed

    steps:
      - name: Check build status
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Lint & Test**: ${{ needs.lint-and-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Terraform**: ${{ needs.terraform-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY

          # Only fail if critical jobs failed
          if [[ "${{ needs.lint-and-test.result }}" == "failure" ]] || \
            [[ "${{ needs.docker-build.result }}" == "failure" ]]; then
            echo "Build failed - check logs above" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "All critical checks passed!" >> $GITHUB_STEP_SUMMARY
          fi
